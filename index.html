<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ClimaGuard - ã‚ãªãŸã®é˜²ç½AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ</title>
<style>
  /* Reset & Basic */
  * {
    box-sizing: border-box;
  }
  body {
    margin:0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    background: #f0f4f8; color: #222; line-height: 1.5;
    display: flex; flex-direction: column; min-height: 100vh;
  }
  header {
    background: #0366d6; color: white; padding: 1rem;
    text-align: center; font-weight: bold; font-size: 1.5rem;
  }
  main {
    flex: 1; max-width: 900px; margin: 1rem auto; padding: 0 1rem;
    width: 100%;
  }
  section {
    background: white; border-radius: 8px; box-shadow: 0 2px 6px rgb(0 0 0 / 0.1);
    margin-bottom: 1.5rem; padding: 1rem 1.25rem;
  }
  h2, h3 {
    margin-top: 0; color: #0366d6;
  }
  select, input, button {
    font-size: 1rem; padding: 0.4rem 0.6rem; border-radius: 4px; border: 1px solid #ccc;
  }
  select {
    min-width: 160px;
  }
  button {
    background: #0366d6; color: white; border: none; cursor: pointer;
    transition: background-color 0.2s ease;
  }
  button:hover {
    background: #024ea2;
  }
  ul {
    list-style: none; padding-left: 0; margin: 0.5rem 0;
  }
  ul li {
    padding: 0.25rem 0; border-bottom: 1px solid #eee;
    display: flex; align-items: center;
  }
  ul li:last-child {
    border-bottom: none;
  }
  .alert-icon {
    color: #e55353; margin-right: 0.5rem; font-weight: bold;
  }
  #radar img {
    max-width: 100%; border-radius: 4px; margin-top: 0.5rem;
    box-shadow: 0 2px 8px rgb(0 0 0 / 0.15);
  }
  #livecam iframe {
    width: 100%; height: 220px; border: none; border-radius: 6px;
  }
  #observation canvas {
    width: 100% !important; height: 180px !important;
  }
  /* Chat UI */
  #chat-ai {
    display: flex; flex-direction: column;
  }
  #chat-input {
    flex: none; width: 100%; padding: 0.6rem; margin-bottom: 0.5rem;
    border-radius: 4px; border: 1px solid #ccc;
  }
  #chat-send {
    align-self: flex-end; padding: 0.5rem 1rem;
    background-color: #0366d6; color: white; border: none; border-radius: 4px;
    cursor: pointer;
  }
  #chat-send:hover {
    background-color: #024ea2;
  }
  #ai-response {
    margin-top: 0.75rem; padding: 0.75rem; background: #e6f0ff;
    border-radius: 6px; min-height: 3rem; white-space: pre-wrap;
  }

  /* Responsive */
  @media (max-width: 480px) {
    header {
      font-size: 1.25rem;
    }
    main {
      padding: 0 0.5rem;
    }
  }
</style>
</head>
<body>
<header>
  ClimaGuard - ã‚ãªãŸã®é˜²ç½AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ
</header>
<main>
  <section id="region-select-section">
    <label for="region-select"><strong>åœ°åŸŸã‚’é¸æŠã—ã¦ãã ã•ã„ï¼š</strong></label>
    <select id="region-select" aria-label="åœ°åŸŸé¸æŠ">
      <!-- éƒ½é“åºœçœŒãƒªã‚¹ãƒˆã¯JSã§ç”Ÿæˆ -->
    </select>
  </section>

  <section id="guardian">
    <h2>ğŸ§  ä»Šæ—¥ã®é˜²ç½ã‚¢ãƒ‰ãƒã‚¤ã‚¹</h2>
    <p id="advisor-comment">èª­ã¿è¾¼ã¿ä¸­...</p>
    <button id="speak-btn" aria-label="é˜²ç½ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’éŸ³å£°ã§èª­ã‚€">ğŸ”Š éŸ³å£°èª­ã¿ä¸Šã’</button>
  </section>

  <section id="alerts">
    <h3>ğŸš¨ ç™ºè¡¨ä¸­ã®è­¦å ±ãƒ»æ³¨æ„å ±</h3>
    <ul id="alert-list">
      <li>èª­ã¿è¾¼ã¿ä¸­...</li>
    </ul>
  </section>

  <section id="radar">
    <h3>ğŸŒ§ï¸ é›¨é›²ãƒ¬ãƒ¼ãƒ€ãƒ¼ã¨é€²è¡Œæ–¹å‘</h3>
    <img id="radar-img" alt="æœ€æ–°ã®é›¨é›²ãƒ¬ãƒ¼ãƒ€ãƒ¼ç”»åƒ" src="" />
    <p id="radar-direction">èª­ã¿è¾¼ã¿ä¸­...</p>
  </section>

  <section id="livecam">
    <h3>ğŸ“º ãƒ©ã‚¤ãƒ–ã‚«ãƒ¡ãƒ©æ˜ åƒ</h3>
    <iframe id="livecam-iframe" title="ãƒ©ã‚¤ãƒ–ã‚«ãƒ¡ãƒ©æ˜ åƒ" src="" allowfullscreen></iframe>
  </section>

  <section id="observation">
    <h3>ğŸ“Š æ°—è±¡è¦³æ¸¬ãƒ‡ãƒ¼ã‚¿</h3>
    <canvas id="chart-temp"></canvas>
  </section>

  <section id="chat-ai">
    <h3>ğŸ’¬ ClimaGuardã«ç›¸è«‡ã™ã‚‹</h3>
    <input type="text" id="chat-input" placeholder="ä¾‹ï¼šå‚˜ã„ã‚‹ï¼Ÿæ´—æ¿¯ã§ãã‚‹ï¼Ÿ" aria-label="AIã¸ã®è³ªå•å…¥åŠ›" />
    <button id="chat-send" aria-label="è³ªå•é€ä¿¡">é€ä¿¡</button>
    <div id="ai-response" role="log" aria-live="polite"></div>
  </section>
</main>

<script>
  (() => {
  // --- å®šæ•°ãƒ»ãƒ‡ãƒ¼ã‚¿ ---
  const PREFS = [
    {code: "hokkaido", name: "åŒ—æµ·é“"}, {code: "aomori", name: "é’æ£®çœŒ"}, {code: "iwate", name: "å²©æ‰‹çœŒ"},
    {code: "miyagi", name: "å®®åŸçœŒ"}, {code: "akita", name: "ç§‹ç”°çœŒ"}, {code: "yamagata", name: "å±±å½¢çœŒ"},
    {code: "fukushima", name: "ç¦å³¶çœŒ"}, {code: "ibaraki", name: "èŒ¨åŸçœŒ"}, {code: "tochigi", name: "æ ƒæœ¨çœŒ"},
    {code: "gunma", name: "ç¾¤é¦¬çœŒ"}, {code: "saitama", name: "åŸ¼ç‰çœŒ"}, {code: "chiba", name: "åƒè‘‰çœŒ"},
    {code: "tokyo", name: "æ±äº¬éƒ½"}, {code: "kanagawa", name: "ç¥å¥ˆå·çœŒ"}, {code: "niigata", name: "æ–°æ½ŸçœŒ"},
    {code: "toyama", name: "å¯Œå±±çœŒ"}, {code: "ishikawa", name: "çŸ³å·çœŒ"}, {code: "fukui", name: "ç¦äº•çœŒ"},
    {code: "yamanashi", name: "å±±æ¢¨çœŒ"}, {code: "nagano", name: "é•·é‡çœŒ"}, {code: "gifu", name: "å²é˜œçœŒ"},
    {code: "shizuoka", name: "é™å²¡çœŒ"}, {code: "aichi", name: "æ„›çŸ¥çœŒ"}, {code: "mie", name: "ä¸‰é‡çœŒ"},
    {code: "shiga", name: "æ»‹è³€çœŒ"}, {code: "kyoto", name: "äº¬éƒ½åºœ"}, {code: "osaka", name: "å¤§é˜ªåºœ"},
    {code: "hyogo", name: "å…µåº«çœŒ"}, {code: "nara", name: "å¥ˆè‰¯çœŒ"}, {code: "wakayama", name: "å’Œæ­Œå±±çœŒ"},
    {code: "tottori", name: "é³¥å–çœŒ"}, {code: "shimane", name: "å³¶æ ¹çœŒ"}, {code: "okayama", name: "å²¡å±±çœŒ"},
    {code: "hiroshima", name: "åºƒå³¶çœŒ"}, {code: "yamaguchi", name: "å±±å£çœŒ"}, {code: "tokushima", name: "å¾³å³¶çœŒ"},
    {code: "kagawa", name: "é¦™å·çœŒ"}, {code: "ehime", name: "æ„›åª›çœŒ"}, {code: "kochi", name: "é«˜çŸ¥çœŒ"},
    {code: "fukuoka", name: "ç¦å²¡çœŒ"}, {code: "saga", name: "ä½è³€çœŒ"}, {code: "nagasaki", name: "é•·å´çœŒ"},
    {code: "kumamoto", name: "ç†Šæœ¬çœŒ"}, {code: "oita", name: "å¤§åˆ†çœŒ"}, {code: "miyazaki", name: "å®®å´çœŒ"},
    {code: "kagoshima", name: "é¹¿å…å³¶çœŒ"}, {code: "okinawa", name: "æ²–ç¸„çœŒ"}
  ];

  // JSONé…ç½®ãƒ‘ã‚¹ï¼ˆGitHub Pagesã®dataãƒ•ã‚©ãƒ«ãƒ€æƒ³å®šï¼‰
  const BASE_URL = "./data/";

  // YouTubeãƒ©ã‚¤ãƒ–ã‚«ãƒ¡ãƒ©åˆ‡æ›¿ç”¨ï¼ˆæ™‚é–“å¸¯ã¨åœ°åŸŸã‚³ãƒ¼ãƒ‰ã§URLæ±ºå®šï¼‰
  // ç°¡æ˜“ç‰ˆï¼šæ±äº¬ãƒ»å¤§é˜ªãƒ»åŒ—æµ·é“ã®ã¿ã€‚å¿…è¦ãªã‚‰å¢—ã‚„ã›ã¾ã™ã€‚
  const LIVE_CAM_LIST = {
    tokyo: [
      {start: 6, end: 18, url: "https://www.youtube.com/embed/live_stream?channel=UCRjJSe4qHVqz2H3o7vV1TqA"}, //æ—¥ä¸­
      {start: 18, end: 24, url: "https://www.youtube.com/embed/live_stream?channel=UCRjJSe4qHVqz2H3o7vV1TqA"}, //å¤œé–“åŒã˜
      {start: 0, end: 6, url: "https://www.youtube.com/embed/live_stream?channel=UCRjJSe4qHVqz2H3o7vV1TqA"}   //æ·±å¤œåŒã˜
    ],
    osaka: [
      {start: 6, end: 18, url: "https://www.youtube.com/embed/live_stream?channel=UC-HwNTA_O5O3g6gl76Mv3Xg"},
      {start: 18, end: 24, url: "https://www.youtube.com/embed/live_stream?channel=UC-HwNTA_O5O3g6gl76Mv3Xg"},
      {start: 0, end: 6, url: "https://www.youtube.com/embed/live_stream?channel=UC-HwNTA_O5O3g6gl76Mv3Xg"}
    ],
    hokkaido: [
      {start: 6, end: 18, url: "https://www.youtube.com/embed/live_stream?channel=UCo2Aq09rW10hF7SYKq1N5tQ"},
      {start: 18, end: 24, url: "https://www.youtube.com/embed/live_stream?channel=UCo2Aq09rW10hF7SYKq1N5tQ"},
      {start: 0, end: 6, url: "https://www.youtube.com/embed/live_stream?channel=UCo2Aq09rW10hF7SYKq1N5tQ"}
    ]
  };

  // ç”»é¢è¦ç´ å‚ç…§
  const regionSelect = document.getElementById("region-select");
  const advisorComment = document.getElementById("advisor-comment");
  const speakBtn = document.getElementById("speak-btn");
  const alertList = document.getElementById("alert-list");
  const radarImg = document.getElementById("radar-img");
  const radarDirection = document.getElementById("radar-direction");
  const livecamIframe = document.getElementById("livecam-iframe");
  const chatInput = document.getElementById("chat-input");
  const chatSend = document.getElementById("chat-send");
  const aiResponse = document.getElementById("ai-response");

  // ãƒãƒ£ãƒ¼ãƒˆç”¨ã‚­ãƒ£ãƒ³ãƒã‚¹
  const ctxTemp = document.getElementById("chart-temp").getContext("2d");
  let tempChart;

  // çŠ¶æ…‹ä¿æŒ
  let advisorData = {};
  let alertsData = {};
  let radarData = {};
  let observationData = {};

  // åˆæœŸå‡¦ç†
  function init() {
    // éƒ½é“åºœçœŒé¸æŠè‚¢ç”Ÿæˆ
    for (const pref of PREFS) {
      const option = document.createElement("option");
      option.value = pref.code;
      option.textContent = pref.name;
      regionSelect.appendChild(option);
    }

    // ä¿å­˜åœ°åŸŸãŒã‚ã‚Œã°ã‚»ãƒƒãƒˆã€ãªã‘ã‚Œã°æ±äº¬
    const savedRegion = localStorage.getItem("climaguard_region") || "tokyo";
    regionSelect.value = savedRegion;

    loadAllData(savedRegion);

    // ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²
    regionSelect.addEventListener("change", (e) => {
      const val = e.target.value;
      localStorage.setItem("climaguard_region", val);
      loadAllData(val);
    });

    speakBtn.addEventListener("click", () => {
      if (!advisorComment.textContent || advisorComment.textContent === "èª­ã¿è¾¼ã¿ä¸­...") return;
      speakText(advisorComment.textContent);
    });

    chatSend.addEventListener("click", sendChatQuery);
    chatInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter") sendChatQuery();
    });
  }

  // ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¸€æ‹¬ãƒ­ãƒ¼ãƒ‰
  async function loadAllData(region) {
    advisorComment.textContent = "èª­ã¿è¾¼ã¿ä¸­...";
    alertList.innerHTML = '<li>èª­ã¿è¾¼ã¿ä¸­...</li>';
    radarImg.src = "";
    radarDirection.textContent = "èª­ã¿è¾¼ã¿ä¸­...";
    aiResponse.textContent = "";
    chatInput.value = "";

    try {
      [advisorData, alertsData, radarData, observationData] = await Promise.all([
        fetchJSON(`advisor_${region}.json`),
        fetchJSON(`alerts.json`),
        fetchJSON(`radarDirection.json`),
        fetchJSON(`observation_${region}.json`)
      ]);
      updateUI(region);
    } catch (e) {
      console.error(e);
      advisorComment.textContent = "ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
      alertList.innerHTML = '<li>ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</li>';
      radarDirection.textContent = "";
    }
  }

  // JSONå–å¾—ã®ãƒ©ãƒƒãƒ‘ãƒ¼
  async function fetchJSON(url) {
    const res = await fetch(BASE_URL + url);
    if (!res.ok) throw new Error(`Failed to fetch ${url}`);
    return await res.json();
  }

  // UIæ›´æ–°é–¢æ•°
  function updateUI(region) {
    // é˜²ç½ã‚¢ãƒ‰ãƒã‚¤ã‚¹è¡¨ç¤º
    if(advisorData.comment){
      advisorComment.textContent = advisorData.comment;
    } else {
      advisorComment.textContent = "æœ¬æ—¥ã®é˜²ç½ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚";
    }

    // è­¦å ±ãƒ»æ³¨æ„å ±ãƒªã‚¹ãƒˆæ›´æ–°
    if(alertsData.alerts && alertsData.alerts.length > 0){
      alertList.innerHTML = "";
      alertsData.alerts.forEach(alert => {
        const li = document.createElement("li");
        li.innerHTML = `<span class="alert-icon">âš ï¸</span>${alert.level}ï¼š${alert.message}`;
        alertList.appendChild(li);
      });
    } else {
      alertList.innerHTML = "<li>ç¾åœ¨ç™ºè¡¨ä¸­ã®è­¦å ±ãƒ»æ³¨æ„å ±ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</li>";
    }

    // é›¨é›²ãƒ¬ãƒ¼ãƒ€ãƒ¼ç”»åƒ
    if(radarData.imageUrl){
      radarImg.src = radarData.imageUrl;
      radarImg.alt = radarData.description || "æœ€æ–°ã®é›¨é›²ãƒ¬ãƒ¼ãƒ€ãƒ¼ç”»åƒ";
    } else {
      radarImg.src = "";
      radarImg.alt = "é›¨é›²ãƒ¬ãƒ¼ãƒ€ãƒ¼ç”»åƒãªã—";
    }
    // ãƒ¬ãƒ¼ãƒ€ãƒ¼é€²è¡Œæ–¹å‘ãƒ†ã‚­ã‚¹ãƒˆ
    radarDirection.textContent = radarData.direction ? `é›¨é›²ã®é€²è¡Œæ–¹å‘ï¼š${radarData.direction}` : "";

    // ãƒ©ã‚¤ãƒ–ã‚«ãƒ¡ãƒ©åˆ‡æ›¿
    updateLiveCam(region);

    // æ°—è±¡è¦³æ¸¬ãƒ‡ãƒ¼ã‚¿ã‚°ãƒ©ãƒ•æ›´æ–°
    if(observationData && observationData.temperatures && observationData.temperatures.length > 0){
      updateTempChart(observationData.temperatures);
    } else {
      clearTempChart();
    }
  }

  // ãƒ©ã‚¤ãƒ–ã‚«ãƒ¡ãƒ©åˆ‡æ›¿å‡¦ç†
  function updateLiveCam(region) {
    const cams = LIVE_CAM_LIST[region] || LIVE_CAM_LIST["tokyo"];
    const hour = new Date().getHours();
    const cam = cams.find(c => hour >= c.start && hour < c.end) || cams[0];
    livecamIframe.src = cam.url;
  }

  // æ°—æ¸©ãƒãƒ£ãƒ¼ãƒˆæç”»ãƒ»æ›´æ–°
  function updateTempChart(data) {
    if(tempChart) {
      tempChart.data.labels = data.map(d => d.time);
      tempChart.data.datasets[0].data = data.map(d => d.value);
      tempChart.update();
      return;
    }
    tempChart = new Chart(ctxTemp, {
      type: 'line',
      data: {
        labels: data.map(d => d.time),
        datasets: [{
          label: 'æ°—æ¸©(â„ƒ)',
          data: data.map(d => d.value),
          borderColor: '#0366d6',
          backgroundColor: 'rgba(3,102,214,0.3)',
          fill: true,
          tension: 0.3,
          pointRadius: 3,
          pointHoverRadius: 6,
          borderWidth: 2,
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: false,
            suggestedMin: Math.min(...data.map(d => d.value)) - 5,
            suggestedMax: Math.max(...data.map(d => d.value)) + 5
          }
        },
        plugins: {
          legend: { display: true },
          tooltip: { enabled: true }
        }
      }
    });
  }

  // æ°—æ¸©ãƒãƒ£ãƒ¼ãƒˆã‚¯ãƒªã‚¢
  function clearTempChart() {
    if(tempChart) {
      tempChart.destroy();
      tempChart = null;
    }
  }
</script>
